<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Add or Update Product</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="add_product.css" />
    <style>
      .hidden {
        display: none;
      }
    </style>
  </head>
  <body>
    <!-- Navbar (unchanged) -->
    <nav
      class="navbar navbar-expand-lg navbar-dark"
      style="background-color: #005e31"
    >
      <div class="container-fluid">
        <a class="navbar-brand" href="#">Stock Management</a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNav"
          aria-controls="navbarNav"
          aria-expanded="false"
          aria-label="Toggle navigation"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav ms-auto">
            <li class="nav-item">
              <a class="nav-link" href="dashboard.html">Home</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="add_product.html">New Product</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="create_report.html">Daily Report</a>
            </li>
            <li class="nav-item">
              <a class="nav-link active" href="view_report_history.html"
                >Report History</a
              >
            </li>
            <li class="nav-item">
              <a class="nav-link" href="product_history.html"
                >Product Overview</a
              >
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#" id="logoutButton">Log-Out</a>
            </li>
          </ul>
        </div>
      </div>
    </nav>
    <!-- Add or Update Product Form -->
    <div class="container mt-5">
      <h3 class="text-center mb-4">Add or Update Product</h3>
      <form id="productForm">
        <div class="mb-3">
          <label for="productName" class="form-label">Product Name</label>
          <input
            type="text"
            class="form-control"
            id="productName"
            placeholder="Enter product name"
            required
          />
        </div>
        <div class="mb-3">
          <label for="productType" class="form-label">Product Type</label>
          <select class="form-select" id="productType" required>
            <option value="">Choose product type...</option>
            <option value="material">Material</option>
            <option value="tool">Tool</option>
            <option value="machine">Machine</option>
            <option value="other">Other</option>
          </select>
        </div>
        <div class="mb-3" id="quantitySection">
          <label for="quantity" class="form-label">Quantity</label>
          <div id="materialQuantityInputs" class="hidden">
            <input
              type="number"
              class="form-control mb-2"
              id="quantityKg"
              placeholder="Enter quantity in kilograms"
              step="0.01"
            />
            <input
              type="number"
              class="form-control"
              id="quantityG"
              placeholder="Enter quantity in grams"
              step="1"
            />
          </div>
          <input
            type="number"
            class="form-control hidden"
            id="quantityOther"
            placeholder="Enter quantity"
          />
        </div>
        <div id="errorMessage" class="text-danger text-center mb-3"></div>
        <button type="submit" class="btn btn-success w-100" id="addButton">
          Add Product
        </button>
        <button
          type="button"
          class="btn btn-primary w-100 mt-2 hidden"
          id="updateButton"
        >
          Update Product
        </button>
      </form>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Firebase Configuration -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
      import {
        getDatabase,
        ref,
        get,
        push,
        update,
      } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-database.js";
      import {
        getAuth,
        signOut,
      } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";

      // Firebase configuration
      const firebaseConfig = {
        apiKey: "AIzaSyBOUqZ-2pHBkeni3XBkWP8F__aXnU-cnzc",
        authDomain: "qf-stock-management-system.firebaseapp.com",
        databaseURL:
          "https://qf-stock-management-system-default-rtdb.firebaseio.com",
        projectId: "qf-stock-management-system",
        storageBucket: "qf-stock-management-system.appspot.com",
        messagingSenderId: "269936772287",
        appId: "1:269936772287:web:c7b20ae6fd43f9723b320a",
        measurementId: "G-XRTFW0MVPS",
      };

      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      const database = getDatabase(app);
      const auth = getAuth(app);

      const productForm = document.getElementById("productForm");
      const productNameInput = document.getElementById("productName");
      const productTypeSelect = document.getElementById("productType");
      const materialQuantityInputs = document.getElementById(
        "materialQuantityInputs"
      );
      const quantityOtherInput = document.getElementById("quantityOther");
      const errorMessageDiv = document.getElementById("errorMessage");
      const addButton = document.getElementById("addButton");
      const updateButton = document.getElementById("updateButton");

      let currentProductKey = null;
      let currentProductType = null;
      let currentQuantity = null;

      // Handle product type change
      productTypeSelect.addEventListener("change", (e) => {
        const productType = e.target.value;
        if (productType === "material") {
          materialQuantityInputs.classList.remove("hidden");
          quantityOtherInput.classList.add("hidden");
        } else {
          materialQuantityInputs.classList.add("hidden");
          quantityOtherInput.classList.remove("hidden");
        }
      });

      // Handle product submission
      productForm.addEventListener("submit", (e) => {
        e.preventDefault();
        handleProductSubmission();
      });

      // Handle product submission (add or update)
      function handleProductSubmission() {
        const productName = productNameInput.value.trim();
        const productType = productTypeSelect.value;
        let quantity = getQuantityValue();

        errorMessageDiv.innerText = "";
        addButton.disabled = true;

        // Check if the product already exists
        const productRef = ref(database, "products");
        get(productRef)
          .then((snapshot) => {
            let productExists = false;
            let productKey = "";

            snapshot.forEach((childSnapshot) => {
              if (
                childSnapshot.val().productName.toLowerCase() ===
                productName.toLowerCase()
              ) {
                productExists = true;
                productKey = childSnapshot.key;
                currentProductType = childSnapshot.val().productType;
                currentQuantity = childSnapshot.val().quantity;
              }
            });

            if (productExists) {
              currentProductKey = productKey;
              showUpdateButton();
              errorMessageDiv.innerText =
                "Product exists. You can update the quantity.";
            } else {
              addNewProduct(productName, productType, quantity);
            }
          })
          .catch((error) => {
            showError("Error checking product: " + error.message);
          })
          .finally(() => {
            addButton.disabled = false;
          });
      }

      // Add new product
      function addNewProduct(productName, productType, quantity) {
        push(ref(database, "products"), {
          productName: productName,
          productType: productType,
          quantity: quantity,
        })
          .then(() => {
            alert("Product added successfully!");
            resetForm();
          })
          .catch((error) => {
            showError("Error adding product: " + error.message);
          });
      }

      // Update existing product
      function updateExistingProduct() {
        if (!currentProductKey) {
          showError("No product selected for update");
          return;
        }

        const newQuantity = getQuantityValue();
        const updatedQuantity = addQuantities(currentQuantity, newQuantity);

        update(ref(database, `products/${currentProductKey}`), {
          quantity: updatedQuantity,
        })
          .then(() => {
            alert("Product updated successfully!");
            resetForm();
          })
          .catch((error) => {
            showError("Error updating product: " + error.message);
          });
      }

      // Get quantity value based on product type
      function getQuantityValue() {
        const productType = productTypeSelect.value;
        if (productType === "material") {
          const quantityKg =
            parseFloat(document.getElementById("quantityKg").value) || 0;
          const quantityG =
            parseFloat(document.getElementById("quantityG").value) || 0;
          return quantityKg > 0
            ? `${quantityKg} kg ${quantityG} g`.trim()
            : `${quantityG} g`.trim();
        } else {
          return quantityOtherInput.value;
        }
      }

      // Add quantities
      function addQuantities(oldQuantity, newQuantity) {
        if (currentProductType === "material") {
          const oldParts = oldQuantity.split(" ");
          const newParts = newQuantity.split(" ");

          let oldKg = 0,
            oldG = 0,
            newKg = 0,
            newG = 0;

          for (let i = 0; i < oldParts.length; i += 2) {
            if (oldParts[i + 1] === "kg") oldKg = parseFloat(oldParts[i]);
            if (oldParts[i + 1] === "g") oldG = parseFloat(oldParts[i]);
          }

          for (let i = 0; i < newParts.length; i += 2) {
            if (newParts[i + 1] === "kg") newKg = parseFloat(newParts[i]);
            if (newParts[i + 1] === "g") newG = parseFloat(newParts[i]);
          }

          let totalG = (oldKg + newKg) * 1000 + oldG + newG;
          let totalKg = Math.floor(totalG / 1000);
          totalG = totalG % 1000;

          return totalKg > 0
            ? `${totalKg} kg ${totalG} g`.trim()
            : `${totalG} g`.trim();
        } else {
          return (parseFloat(oldQuantity) + parseFloat(newQuantity)).toString();
        }
      }

      // Show update button
      function showUpdateButton() {
        addButton.classList.add("hidden");
        updateButton.classList.remove("hidden");
      }

      // Reset form
      function resetForm() {
        productForm.reset();
        materialQuantityInputs.classList.add("hidden");
        quantityOtherInput.classList.add("hidden");
        addButton.classList.remove("hidden");
        updateButton.classList.add("hidden");
        currentProductKey = null;
        currentProductType = null;
        currentQuantity = null;
        errorMessageDiv.innerText = "";
      }

      // Show error message
      function showError(message) {
        errorMessageDiv.innerText = message;
      }

      // Handle update button click
      updateButton.addEventListener("click", updateExistingProduct);

      // Handle logout
      document.getElementById("logoutButton").addEventListener("click", (e) => {
        e.preventDefault();
        if (confirm("Are you sure you want to log out?")) {
          signOut(auth)
            .then(() => {
              window.location.href = "login.html";
            })
            .catch((error) => {
              console.error("Logout failed:", error);
              alert("Logout failed: " + error.message);
            });
        }
      });
    </script>
  </body>
</html>
